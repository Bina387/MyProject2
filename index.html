/**
 * Single-file AI Chat app (frontend + server) using OpenAI Chat Completions.
 *
 * USAGE (test only):
 * 1. Install Node.js (v18+ recommended).
 * 2. Save this file as `app.js`.
 * 3. Run: npm init -y
 *          npm install express node-fetch
 * 4. Edit the OPENAI_API_KEY constant below and paste your key for testing ONLY.
 *    Do NOT commit or share the key. Remove it after testing or use environment variables.
 * 5. Start: node app.js
 * 6. Open http://localhost:3000
 *
 * NOTE: This file intentionally places the API key in a variable for quick local testing.
 * For production, always use environment variables or a secure secrets manager.
 */

const express = require('express');
const fetch = require('node-fetch'); // npm install node-fetch
const path = require('path');

const app = express();
app.use(express.json());

// --------------------
// Paste your OpenAI API key here for quick local testing ONLY.
// Replace the string below with your key, then start the server.
// WARNING: Do NOT commit this file with the key to any public repo.
const OPENAI_API_KEY = 'PASTE_YOUR_OPENAI_API_KEY_HERE';
// --------------------

// Basic check
if (!OPENAI_API_KEY || OPENAI_API_KEY === 'PASTE_YOUR_OPENAI_API_KEY_HERE') {
  console.warn('Warning: OPENAI_API_KEY is not set or left as placeholder. The AI endpoint will return an error until you paste a valid key.');
}

// Serve the single-page frontend
app.get('/', (req, res) => {
  res.setHeader('Content-Type', 'text/html; charset=utf-8');
  res.send(`<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI Chat Assistant (Single File)</title>
<style>
  :root{--accent-1:#7c4dff;--accent-2:#00d4ff;--bg:#0b1220;--text:#e9eef8}
  html,body{height:100%;margin:0;font-family:Inter,Segoe UI,system-ui,Arial,sans-serif;background:linear-gradient(135deg,#0b0710,#121026);color:var(--text)}
  body{display:flex;flex-direction:column}
  header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:rgba(255,255,255,0.02);backdrop-filter:blur(6px)}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent-1),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff}
  main{display:flex;gap:16px;padding:16px;flex:1;min-height:0}
  .panel{flex:1;display:flex;flex-direction:column;border-radius:12px;padding:12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);min-width:0}
  #chat-container{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
  .message{max-width:78%;padding:12px;border-radius:12px;line-height:1.35;word-wrap:break-word}
  .message.user{margin-left:auto;background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:white}
  .message.bot{margin-right:auto;background:rgba(255,255,255,0.03);color:var(--text);border:1px solid rgba(255,255,255,0.02)}
  #input-area{display:flex;gap:8px;padding-top:10px;border-top:1px dashed rgba(255,255,255,0.02)}
  #user-input{flex:1;padding:10px;border-radius:8px;border:none;background:rgba(255,255,255,0.02);color:var(--text);outline:none}
  #send-btn{padding:10px 14px;border-radius:8px;border:none;background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:white;cursor:pointer}
  .controls{display:flex;gap:8px;align-items:center}
  .ghost-btn{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text);cursor:pointer}
  .side{width:300px;display:flex;flex-direction:column;gap:12px}
  .card{padding:12px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
  #info-modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);min-width:320px;max-width:90%;z-index:9999;padding:16px;border-radius:12px;display:none;background:rgba(10,10,12,0.95);color:var(--text)}
  #info-modal input{width:100%;padding:8px;margin-top:6px;border-radius:8px;border:none;background:rgba(255,255,255,0.02);color:var(--text)}
  footer{padding:10px 16px;color:rgba(233,238,248,0.7);text-align:center}
  @media (max-width:900px){main{flex-direction:column}.side{width:100%}}
</style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">AI</div>
      <div>
        <div style="font-weight:600">AI Chat Assistant</div>
        <div style="font-size:0.85rem;color:rgba(233,238,248,0.7)">Local test with OpenAI key (paste for testing only)</div>
      </div>
    </div>

    <div class="controls" role="toolbar" aria-label="Controls">
      <select id="model-select" title="Choose model">
        <option value="gpt-4o">gpt-4o</option>
        <option value="gpt-4o-mini">gpt-4o-mini</option>
        <option value="gpt-4">gpt-4</option>
        <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
      </select>
      <button id="toggle-mode" class="ghost-btn" title="Toggle theme">üåô</button>
      <button id="info-btn" class="ghost-btn" title="Developer info">‚ÑπÔ∏è</button>
      <button id="download-btn" class="ghost-btn" title="Download chat">‚¨áÔ∏è</button>
      <button id="clear-btn" class="ghost-btn" title="Clear chat">üóëÔ∏è</button>
    </div>
  </header>

  <main>
    <section class="panel" aria-label="Chat panel">
      <div id="chat-container" role="log" aria-live="polite"></div>

      <div id="input-area">
        <input id="user-input" type="text" placeholder="Ask me anything..." aria-label="Message input" />
        <button id="send-btn" aria-label="Send message">Send</button>
      </div>
    </section>

    <aside class="side" aria-label="Sidebar">
      <div class="card">
        <h3 style="margin:0 0 8px 0">Quick tips</h3>
        <div style="color:rgba(233,238,248,0.7)">Try: "Explain quantum entanglement", "Write a short poem", or "Who created you?"</div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px 0">Developer</h3>
        <div id="dev-preview" style="display:flex;gap:12px;align-items:center">
          <img id="dev-pic" src="" alt="dev" style="width:56px;height:56px;border-radius:8px;object-fit:cover;background:linear-gradient(90deg,#7c4dff,#00d4ff)">
          <div>
            <div id="dev-name" style="font-weight:600">Your Name</div>
            <div id="dev-contact" style="color:rgba(233,238,248,0.7)">your@email.com ‚Ä¢ +123456789</div>
          </div>
        </div>
      </div>
    </aside>
  </main>

  <footer>Local test server proxy to OpenAI. Do not expose your key publicly.</footer>

  <!-- Info Modal -->
  <div id="info-modal">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Developer Info</strong>
      <button id="close-info" class="ghost-btn" style="padding:6px 8px">‚úï</button>
    </div>

    <div style="margin-top:12px">
      <label style="color:rgba(233,238,248,0.8)">Name</label>
      <input id="dev-name-input" type="text" placeholder="Your Name">
      <label style="color:rgba(233,238,248,0.8);margin-top:8px">Email</label>
      <input id="dev-email-input" type="text" placeholder="you@example.com">
      <label style="color:rgba(233,238,248,0.8);margin-top:8px">Phone</label>
      <input id="dev-phone-input" type="text" placeholder="+123456789">
      <label style="color:rgba(233,238,248,0.8);margin-top:8px">Picture URL</label>
      <input id="dev-pic-input" type="text" placeholder="https://example.com/me.jpg">

      <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
        <button id="save-dev" style="padding:10px 14px;background:linear-gradient(90deg,#7c4dff,#00d4ff);color:white;border:none;border-radius:8px">Save</button>
        <button id="reset-dev" class="ghost-btn">Reset</button>
      </div>
    </div>
  </div>

<script>
/* Frontend logic: interacts with server endpoints below */
(() => {
  const chatContainer = document.getElementById('chat-container');
  const userInput = document.getElementById('user-input');
  const sendBtn = document.getElementById('send-btn');
  const modelSelect = document.getElementById('model-select');
  const toggleMode = document.getElementById('toggle-mode');
  const clearBtn = document.getElementById('clear-btn');
  const downloadBtn = document.getElementById('download-btn');
  const infoBtn = document.getElementById('info-btn');
  const infoModal = document.getElementById('info-modal');
  const closeInfo = document.getElementById('close-info');
  const saveDev = document.getElementById('save-dev');
  const resetDev = document.getElementById('reset-dev');

  const devNameInput = document.getElementById('dev-name-input');
  const devEmailInput = document.getElementById('dev-email-input');
  const devPhoneInput = document.getElementById('dev-phone-input');
  const devPicInput = document.getElementById('dev-pic-input');

  const devNamePreview = document.getElementById('dev-name');
  const devContactPreview = document.getElementById('dev-contact');
  const devPicPreview = document.getElementById('dev-pic');

  const DEFAULT_DEV = { name: "Your Name", email: "your@email.com", phone: "+123456789", pic: "" };

  function loadDevInfo(){ try{ const r = localStorage.getItem('devInfo'); return r ? JSON.parse(r) : DEFAULT_DEV; }catch(e){return DEFAULT_DEV} }
  function saveDevInfo(obj){ try{ localStorage.setItem('devInfo', JSON.stringify(obj)); }catch(e){} applyDevInfo(obj); }
  function applyDevInfo(obj){
    devNamePreview.textContent = obj.name || DEFAULT_DEV.name;
    devContactPreview.textContent = \`\${obj.email || DEFAULT_DEV.email} ‚Ä¢ \${obj.phone || DEFAULT_DEV.phone}\`;
    devPicPreview.src = obj.pic || '';
    devNameInput.value = obj.name || '';
    devEmailInput.value = obj.email || '';
    devPhoneInput.value = obj.phone || '';
    devPicInput.value = obj.pic || '';
  }

  function loadHistory(){ try{ const r = localStorage.getItem('chatHistory'); return r ? JSON.parse(r) : []; }catch(e){return []} }
  function saveHistory(arr){ try{ localStorage.setItem('chatHistory', JSON.stringify(arr)); }catch(e){} }
  function appendMessage(text, sender, save=true){
    const el = document.createElement('div');
    el.className = 'message ' + (sender === 'user' ? 'user' : 'bot');
    const content = document.createElement('div');
    content.innerHTML = String(text).replace(/\\n/g,'<br>');
    el.appendChild(content);
    chatContainer.appendChild(el);
    chatContainer.scrollTop = chatContainer.scrollHeight;
    if(save){ const h = loadHistory(); h.push({text, sender, time: Date.now()}); saveHistory(h); }
  }
  function renderHistory(){ chatContainer.innerHTML = ''; loadHistory().forEach(item => appendMessage(item.text, item.sender, false)); }

  function showTyping(){ removeTyping(); const t = document.createElement('div'); t.id='typing-indicator'; t.className='typing'; t.textContent='Bot is typing‚Ä¶'; chatContainer.appendChild(t); chatContainer.scrollTop = chatContainer.scrollHeight; }
  function removeTyping(){ const t = document.getElementById('typing-indicator'); if(t) t.remove(); }

  async function sendMessage(){
    const text = userInput.value.trim();
    if(!text) return;
    appendMessage(text, 'user');
    userInput.value = '';
    showTyping();

    const dev = loadDevInfo();
    const creatorRegex = /\\b(who (created|made|built) (you|this|the assistant)|who is your creator|who developed you|who made you)\\b/i;
    if(creatorRegex.test(text)){
      removeTyping();
      appendMessage(\`I was created by **\${dev.name}** ‚ú®\`, 'bot');
      return;
    }

    try{
      const model = modelSelect.value;
      const resp = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: text, model })
      });

      if(!resp.ok){
        const errText = await resp.text();
        removeTyping();
        appendMessage('‚ö†Ô∏è Server error: ' + errText, 'bot');
        return;
      }

      const data = await resp.json();
      removeTyping();
      appendMessage(data.reply || 'No reply', 'bot');
    }catch(err){
      removeTyping();
      appendMessage('‚ö†Ô∏è Network or server error: ' + (err.message || err), 'bot');
      console.error(err);
    }
  }

  sendBtn.addEventListener('click', sendMessage);
  userInput.addEventListener('keydown', (e) => { if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); } });

  clearBtn.addEventListener('click', () => { localStorage.removeItem('chatHistory'); chatContainer.innerHTML = ''; appendMessage('Chat cleared ‚úÖ', 'bot', false); });
  downloadBtn.addEventListener('click', () => {
    const history = loadHistory();
    if(!history.length){ alert('No chat history to download.'); return; }
    let content = 'AI Chat Assistant Conversation\\n\\n';
    history.forEach(h => { content += (h.sender === 'user' ? 'You: ' : 'Bot: ') + h.text + '\\n\\n'; });
    const blob = new Blob([content], { type: 'text/plain' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'chat_history.txt'; document.body.appendChild(a); a.click(); a.remove();
  });

  infoBtn.addEventListener('click', () => { infoModal.style.display = 'block'; });
  closeInfo.addEventListener('click', () => { infoModal.style.display = 'none'; });
  saveDev.addEventListener('click', () => { saveDevInfo({ name: devNameInput.value.trim() || DEFAULT_DEV.name, email: devEmailInput.value.trim() || DEFAULT_DEV.email, phone: devPhoneInput.value.trim() || DEFAULT_DEV.phone, pic: devPicInput.value.trim() || '' }); infoModal.style.display = 'none'; });
  resetDev.addEventListener('click', () => { saveDevInfo(DEFAULT_DEV); infoModal.style.display = 'none'; });

  (function init(){
    applyDevInfo(loadDevInfo());
    renderHistory();
    if(loadHistory().length === 0) appendMessage("Hello ‚Äî I'm your AI assistant. Ask me anything.", 'bot', false);
  })();
})();
</script>
</body>
</html>`);
});

// --------------------
// API endpoint: /api/chat
// For quick testing only: uses the OPENAI_API_KEY constant above.
// In production, move the key to environment variables and secure the endpoint.
app.post('/api/chat', async (req, res) => {
  try {
    if (!OPENAI_API_KEY || OPENAI_API_KEY === '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') {
      return res.status(500).send('Server not configured with OpenAI API key. Edit app.js and paste your key for testing only.');
    }

    const { message, model } = req.body || {};
    if (!message) return res.status(400).send('Missing "message" in request body.');

    // Build payload for OpenAI Chat Completions
    const payload = {
      model: model || 'gpt-4o',
      messages: [
        { role: 'system', content: 'You are a helpful assistant.' },
        { role: 'user', content: message }
      ],
      temperature: 0.7,
      max_tokens: 800
    };

    const r = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${OPENAI_API_KEY}`
      },
      body: JSON.stringify(payload)
    });

    if (!r.ok) {
      const text = await r.text();
      console.error('OpenAI API error', r.status, text);
      return res.status(502).send('OpenAI API error: ' + text);
    }

    const data = await r.json();
    const reply = data?.choices?.[0]?.message?.content ?? 'No response from model.';
    res.json({ reply });
  } catch (err) {
    console.error('Server error', err);
    res.status(500).send('Server error: ' + (err.message || String(err)));
  }
});

// Serve static (none) and start server
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(\`Server running on http://localhost:\${PORT}\`);
  console.log('Edit the OPENAI_API_KEY constant in this file to paste your key for testing only.');
});
